<!DOCTYPE html>
<html>
<head>
	<title>自定义Axios</title>
</head>
<body>
	<h1>模拟实现axios请求</h1>
	<button onclick="getdata()">请求</button>
	<button onclick="cancelAxios()">取消请求请求</button>
</body>
</html>
<script type="text/javascript">
// *******模拟实现axios请求*******
	
	// 模拟构造函数
	function Axios(config){
		this.config = config;
	}

	// 原型 request 方法  
	// request必须为promise才行
	Axios.prototype.request = function(config){
		return dispatchRequest(config)
	}
	// dispatchRequest 函数
	function dispatchRequest(config){
		return xhrAdapter(config)
	}
	// xhrAdapter 
	function xhrAdapter(config){	
		// 发送ajax请求
		return new Promise((resolve,reject)=>{
			// 实例化对象
			const xhr = new XMLHttpRequest();
			// 初始化
			xhr.open(config.method,config.url);
			// 发送请求  && 还可带参数
			xhr.send();
			// 处理结果
			xhr.onreadystatechange = function(){
				console.log(xhr)
				if(xhr.readyState === 4){
					if(xhr.status >= 200 && xhr.status < 300){
						resolve({
							status:xhr.status,
							statusText:xhr.statusText,
							response:JSON.parse(xhr.response)
						})
					}else{
						reject(new Error('请求失败'))
					}
				}
			}
			// 取消请求 -- 处理
			if(config.cancelToken1){
				// 对 cancelTokens 对象身上的 promise 对象指定成功的回调
				config.cancelToken1.promise.then(res=>{
					xhr.abort()
					reject('请求已经被取消')
				})
				
			}

		})

	}

	// 创建 axios 函数
	const context = new Axios({});
	const axios1 = Axios.prototype.request.bind(context)
	console.dir(axios1)



// *******取消axios请求*******
	// 取消请求处理（看搜token）
	function CancelToken(executor){
		// 声明变量
		var resolvePromise;
		// 为实例对象添加属性 （因为new CancelToken 所有，this指向CancelToken函数）
		this.promise = new Promise((resolve)=>{
			// 将 resolve 赋值给 resolvePromise
			resolvePromise = resolve;
		})
		// 调用 executor 函数
		executor(function(){
			// 执行 resolvePromise 函数
			resolvePromise();
		})
	}



// ---------------------------1、发起请求--------------------------------
	// 创建 cancelToken 的值
	let cancel = null;
	// 发起请求
	function getdata() {
		// 监测上一次的请求是否已经完成
		if(cancel !== null){
			// 取消上一次请求
			cancel()
		}
		axios1({
			method:'get',
			url:'https://api.apiopen.top/getJoke',
			// 添加配置对象的属性
			cancelToken1: new CancelToken(function(c){
				cancel = c
				console.log(cancel,'---1')
			})
		}).then(res=>{
			console.log(res,'--')
			// 将cancel初始化
			cancel = null
		},err=>{
			// cancel = null
		})
	}

// ---------------------------1、取消请求--------------------------------
	
	function cancelAxios() {
		cancel()
	}
</script>